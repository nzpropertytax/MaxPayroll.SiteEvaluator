@page "/SiteEvaluator/Admin/Credentials"
@model MaxPayroll.SiteEvaluator.Pages.SiteEvaluator.Admin.CredentialsModel
@using MaxPayroll.SiteEvaluator.Models

@{
    ViewData["Title"] = "API Credentials";
    ViewData["NoIndex"] = true;
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">
                        <i class="fa fa-key text-primary me-2"></i>
                        API Credentials
                    </h1>
                    <p class="text-muted mb-0">Manage external service API keys and authentication</p>
                </div>
                <div class="d-flex gap-2">
                    <form method="post" asp-page-handler="Seed" class="d-inline">
                        <button type="submit" class="btn btn-outline-secondary" title="Add any missing default credentials">
                            <i class="fa fa-seedling me-1"></i> Seed Defaults
                        </button>
                    </form>
                    <a href="/SiteEvaluator/Admin/Settings" class="btn btn-outline-secondary">
                        <i class="fa fa-arrow-left me-1"></i> Back to Settings
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row g-4">
        <!-- Credentials List -->
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fa fa-list me-2"></i>Configured Services</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        @if (Model.Credentials.Count == 0)
                        {
                            <div class="list-group-item text-center py-4">
                                <i class="fa fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="mb-0 text-muted">No credentials configured.</p>
                                <form method="post" asp-page-handler="Seed" class="mt-2">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fa fa-seedling me-1"></i> Seed Default Credentials
                                    </button>
                                </form>
                            </div>
                        }
                        else
                        {
                            @foreach (var cred in Model.Credentials.OrderBy(c => c.Provider).ThenBy(c => c.ServiceName))
                            {
                                var isSelected = Model.EditId == cred.Id;
                                var statusClass = cred.Status switch
                                {
                                    CredentialStatus.Active => "text-success",
                                    CredentialStatus.Unknown => "text-warning",
                                    CredentialStatus.Disabled => "text-secondary",
                                    CredentialStatus.Failed => "text-danger",
                                    CredentialStatus.NotConfigured => "text-muted",
                                    _ => "text-muted"
                                };
                                var statusIcon = cred.Status switch
                                {
                                    CredentialStatus.Active => "fa-check-circle",
                                    CredentialStatus.Unknown => "fa-question-circle",
                                    CredentialStatus.Disabled => "fa-ban",
                                    CredentialStatus.Failed => "fa-times-circle",
                                    CredentialStatus.NotConfigured => "fa-circle",
                                    _ => "fa-circle"
                                };

                                <a href="?id=@cred.Id" class="list-group-item list-group-item-action @(isSelected ? "active" : "")">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold">@cred.ServiceName</div>
                                            <small class="@(isSelected ? "text-white-50" : "text-muted")">@cred.Provider</small>
                                        </div>
                                        <div class="text-end">
                                            <i class="fa @statusIcon @statusClass"></i>
                                            @if (cred.HasAuthentication)
                                            {
                                                <i class="fa fa-key ms-1 @(isSelected ? "text-white-50" : "text-success")" title="Credentials configured"></i>
                                            }
                                        </div>
                                    </div>
                                </a>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="card shadow-sm mt-3">
                <div class="card-body py-2">
                    <small class="text-muted">
                        <span class="text-success"><i class="fa fa-check-circle me-1"></i>Active</span>
                        <span class="mx-2">|</span>
                        <span class="text-warning"><i class="fa fa-question-circle me-1"></i>Not Tested</span>
                        <span class="mx-2">|</span>
                        <span class="text-danger"><i class="fa fa-times-circle me-1"></i>Failed</span>
                        <span class="mx-2">|</span>
                        <span class="text-secondary"><i class="fa fa-ban me-1"></i>Disabled</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Edit Form -->
        <div class="col-lg-7">
            @if (Model.SelectedCredential != null)
            {
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fa fa-edit me-2"></i>@Model.SelectedCredential.ServiceName
                        </h5>
                        <div class="d-flex gap-2">
                            <form method="post" asp-page-handler="Test" class="d-inline">
                                <input type="hidden" name="id" value="@Model.EditId" />
                                <button type="submit" class="btn btn-sm btn-outline-primary">
                                    <i class="fa fa-plug me-1"></i> Test Connection
                                </button>
                            </form>
                            <form method="post" asp-page-handler="Toggle" class="d-inline">
                                <input type="hidden" name="id" value="@Model.EditId" />
                                <button type="submit" class="btn btn-sm @(Model.SelectedCredential.IsEnabled ? "btn-outline-warning" : "btn-outline-success")">
                                    <i class="fa @(Model.SelectedCredential.IsEnabled ? "fa-ban" : "fa-check") me-1"></i>
                                    @(Model.SelectedCredential.IsEnabled ? "Disable" : "Enable")
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        <form method="post" asp-page-handler="Save">
                            <input type="hidden" asp-for="EditId" />

                            <!-- Service Info -->
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Service Name</label>
                                    <input type="text" class="form-control" asp-for="Input.ServiceName" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Status</label>
                                    <div class="form-control-plaintext">
                                        @{
                                            var badgeClass = Model.SelectedCredential.Status switch
                                            {
                                                CredentialStatus.Active => "bg-success",
                                                CredentialStatus.Unknown => "bg-warning text-dark",
                                                CredentialStatus.Disabled => "bg-secondary",
                                                CredentialStatus.Failed => "bg-danger",
                                                _ => "bg-light text-dark"
                                            };
                                        }
                                        <span class="badge @badgeClass">@Model.SelectedCredential.Status</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control" asp-for="Input.Description" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Base URL</label>
                                <input type="url" class="form-control" asp-for="Input.BaseUrl" placeholder="https://api.example.com" />
                            </div>

                            <hr class="my-4" />

                            <!-- Authentication -->
                            <h6 class="text-primary mb-3"><i class="fa fa-lock me-2"></i>Authentication</h6>
                            
                            <div class="alert alert-info py-2 small mb-3">
                                <i class="fa fa-info-circle me-1"></i>
                                Sensitive fields are encrypted at rest. Leave unchanged fields blank to preserve existing values.
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">API Key</label>
                                    <input type="password" class="form-control" asp-for="Input.ApiKey" 
                                           placeholder="@(Model.SelectedCredential.HasAuthentication ? "****configured****" : "Enter API key")" />
                                    <small class="form-text text-muted">Primary API key or token</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">API Secret</label>
                                    <input type="password" class="form-control" asp-for="Input.ApiSecret" 
                                           placeholder="Leave blank if not required" />
                                    <small class="form-text text-muted">Secret key (if required)</small>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" asp-for="Input.Username" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" asp-for="Input.Password" 
                                           placeholder="Leave blank if not required" />
                                </div>
                            </div>

                            <!-- OAuth (collapsible) -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#oauthFields">
                                    <i class="fa fa-chevron-down me-1"></i> OAuth / Advanced Fields
                                </button>
                            </div>

                            <div class="collapse" id="oauthFields">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Client ID</label>
                                        <input type="text" class="form-control" asp-for="Input.ClientId" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Client Secret</label>
                                        <input type="password" class="form-control" asp-for="Input.ClientSecret" />
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Access Token</label>
                                        <input type="password" class="form-control" asp-for="Input.AccessToken" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Webhook Secret</label>
                                        <input type="password" class="form-control" asp-for="Input.WebhookSecret" />
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4" />

                            <!-- Options -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" asp-for="Input.IsEnabled" />
                                        <label class="form-check-label" asp-for="Input.IsEnabled">Enabled</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" asp-for="Input.IsTestMode" />
                                        <label class="form-check-label" asp-for="Input.IsTestMode">Test/Sandbox Mode</label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" asp-for="Input.Notes" rows="2"></textarea>
                            </div>

                            <!-- Metadata -->
                            @if (Model.SelectedCredential.LastTestedAt.HasValue || Model.SelectedCredential.LastUsedAt.HasValue)
                            {
                                <div class="bg-light p-3 rounded mb-3">
                                    <div class="row text-muted small">
                                        @if (Model.SelectedCredential.LastTestedAt.HasValue)
                                        {
                                            <div class="col-md-6">
                                                <strong>Last Tested:</strong> @Model.SelectedCredential.LastTestedAt?.ToString("g")
                                                @if (Model.SelectedCredential.LastTestResult == true)
                                                {
                                                    <span class="text-success ms-1"><i class="fa fa-check"></i></span>
                                                }
                                                else if (Model.SelectedCredential.LastTestResult == false)
                                                {
                                                    <span class="text-danger ms-1"><i class="fa fa-times"></i></span>
                                                }
                                            </div>
                                        }
                                        @if (Model.SelectedCredential.LastUsedAt.HasValue)
                                        {
                                            <div class="col-md-6">
                                                <strong>Last Used:</strong> @Model.SelectedCredential.LastUsedAt?.ToString("g")
                                            </div>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(Model.SelectedCredential.LastTestError))
                                    {
                                        <div class="text-danger small mt-2">
                                            <strong>Last Error:</strong> @Model.SelectedCredential.LastTestError
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Links -->
                            @if (!string.IsNullOrEmpty(Model.SelectedCredential.DocumentationUrl) || !string.IsNullOrEmpty(Model.SelectedCredential.ManagementUrl))
                            {
                                <div class="d-flex gap-3 mb-3">
                                    @if (!string.IsNullOrEmpty(Model.SelectedCredential.DocumentationUrl))
                                    {
                                        <a href="@Model.SelectedCredential.DocumentationUrl" target="_blank" class="btn btn-sm btn-outline-secondary">
                                            <i class="fa fa-book me-1"></i> Documentation
                                        </a>
                                    }
                                    @if (!string.IsNullOrEmpty(Model.SelectedCredential.ManagementUrl))
                                    {
                                        <a href="@Model.SelectedCredential.ManagementUrl" target="_blank" class="btn btn-sm btn-outline-secondary">
                                            <i class="fa fa-external-link-alt me-1"></i> Manage API Keys
                                        </a>
                                    }
                                </div>
                            }

                            <div class="d-flex justify-content-end gap-2">
                                <a href="/SiteEvaluator/Admin/Credentials" class="btn btn-outline-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-save me-1"></i> Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fa fa-hand-pointer fa-3x text-muted mb-3"></i>
                        <h5>Select a Service</h5>
                        <p class="text-muted mb-0">Choose a service from the list to configure its API credentials.</p>
                    </div>
                </div>

                <!-- Help Card -->
                <div class="card shadow-sm mt-3">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="fa fa-info-circle me-2"></i>About API Credentials</h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            External API credentials are stored securely in the database with AES-256 encryption for sensitive fields.
                        </p>
                        <ul class="small text-muted mb-0">
                            <li>API keys and secrets are encrypted at rest</li>
                            <li>Credentials are no longer stored in appsettings.json</li>
                            <li>Test connections before using in production</li>
                            <li>Disable unused credentials to prevent accidental usage</li>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>
