@model MaxPayroll.SiteEvaluator.Pages.SiteEvaluator.EvaluationWizardModel
@{
    var evaluation = Model.WizardState.Evaluation;
    var zoning = evaluation?.Zoning;
    var hasData = zoning != null;
}

<!-- Step 3: Zoning Data -->
<div class="wizard-card">
    <div class="wizard-card-header">
        <div class="icon" style="background: #6f42c1;">
            <i class="fa fa-city"></i>
        </div>
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3>Zoning and Planning</h3>
                    <p class="text-muted mb-0">District plan zones, height limits, and permitted activities</p>
                </div>
                @if (hasData)
                {
                    <span class="status-badge complete">
                        <i class="fa fa-check me-1"></i> Data Retrieved
                    </span>
                }
                else
                {
                    <span class="status-badge missing">
                        <i class="fa fa-exclamation-circle me-1"></i> No Data
                    </span>
                }
            </div>
        </div>
    </div>

    @if (hasData)
    {
        <div class="row">
            <!-- Zone Information -->
            <div class="col-md-6">
                <div class="data-section">
                    <h5><i class="fa fa-map-marked-alt me-2"></i>Zone Information</h5>
                    <div class="data-item">
                        <span class="data-label">Zone</span>
                        <span class="data-value">@(zoning.Zone ?? "Not specified")</span>
                    </div>
                    @if (!string.IsNullOrEmpty(zoning.ZoneCode))
                    {
                        <div class="data-item">
                            <span class="data-label">Zone Code</span>
                            <span class="data-value">@zoning.ZoneCode</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(zoning.DistrictPlan))
                    {
                        <div class="data-item">
                            <span class="data-label">District Plan</span>
                            <span class="data-value">@zoning.DistrictPlan</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(zoning.ZoneDescription))
                    {
                        <div class="mt-2">
                            <small class="text-muted">@zoning.ZoneDescription</small>
                        </div>
                    }
                </div>
            </div>

            <!-- Built Form Standards -->
            <div class="col-md-6">
                <div class="data-section">
                    <h5><i class="fa fa-ruler-combined me-2"></i>Built Form Standards</h5>
                    @if (zoning.MaxHeight != null)
                    {
                        <div class="data-item">
                            <span class="data-label">Max Height</span>
                            <span class="data-value">@zoning.MaxHeight.Value.ToString("0.#") m</span>
                        </div>
                    }
                    @if (zoning.MaxCoverage != null)
                    {
                        <div class="data-item">
                            <span class="data-label">Max Coverage</span>
                            <span class="data-value">@zoning.MaxCoverage.Value.ToString("0")%</span>
                        </div>
                    }
                    @if (zoning.MinFrontSetback != null)
                    {
                        <div class="data-item">
                            <span class="data-label">Front Setback</span>
                            <span class="data-value">@zoning.MinFrontSetback.Value.ToString("0.#") m</span>
                        </div>
                    }
                    @if (zoning.MinSideSetback != null)
                    {
                        <div class="data-item">
                            <span class="data-label">Side Setback</span>
                            <span class="data-value">@zoning.MinSideSetback.Value.ToString("0.#") m</span>
                        </div>
                    }
                    @if (zoning.MinRearSetback != null)
                    {
                        <div class="data-item">
                            <span class="data-label">Rear Setback</span>
                            <span class="data-value">@zoning.MinRearSetback.Value.ToString("0.#") m</span>
                        </div>
                    }
                    @if (zoning.MaxImpervious != null)
                    {
                        <div class="data-item">
                            <span class="data-label">Max Impervious</span>
                            <span class="data-value">@zoning.MaxImpervious.Value.ToString("0")%</span>
                        </div>
                    }
                    @if (zoning.MaxHeight == null && zoning.MaxCoverage == null && zoning.MinFrontSetback == null)
                    {
                        <p class="text-muted small mb-0">Built form standards not available</p>
                    }
                </div>
            </div>
        </div>

        <!-- Density Controls -->
        @if (zoning.DensityStandard != null || zoning.MaxUnitsPerSite != null || zoning.MinSiteArea != null)
        {
            <div class="data-section">
                <h5><i class="fa fa-th me-2"></i>Density Controls</h5>
                <div class="row">
                    @if (!string.IsNullOrEmpty(zoning.DensityStandard))
                    {
                        <div class="col-md-4">
                            <div class="data-item">
                                <span class="data-label">Density Standard</span>
                                <span class="data-value">@zoning.DensityStandard</span>
                            </div>
                        </div>
                    }
                    @if (zoning.MaxUnitsPerSite != null)
                    {
                        <div class="col-md-4">
                            <div class="data-item">
                                <span class="data-label">Max Units/Site</span>
                                <span class="data-value">@zoning.MaxUnitsPerSite</span>
                            </div>
                        </div>
                    }
                    @if (zoning.MinSiteArea != null)
                    {
                        <div class="col-md-4">
                            <div class="data-item">
                                <span class="data-label">Min Site Area</span>
                                <span class="data-value">@zoning.MinSiteArea.Value.ToString("0") m2</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Permitted Activities -->
        @if (zoning.PermittedActivities?.Count > 0)
        {
            <div class="data-section">
                <h5><i class="fa fa-check-circle me-2 text-success"></i>Permitted Activities</h5>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var activity in zoning.PermittedActivities)
                    {
                        <span class="badge bg-success-subtle text-success">@activity</span>
                    }
                </div>
            </div>
        }

        <!-- Controlled Activities -->
        @if (zoning.ControlledActivities?.Count > 0)
        {
            <div class="data-section">
                <h5><i class="fa fa-sliders-h me-2 text-info"></i>Controlled Activities</h5>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var activity in zoning.ControlledActivities)
                    {
                        <span class="badge bg-info-subtle text-info">@activity</span>
                    }
                </div>
            </div>
        }

        <!-- Restricted Discretionary -->
        @if (zoning.RestrictedDiscretionary?.Count > 0)
        {
            <div class="data-section">
                <h5><i class="fa fa-exclamation-circle me-2 text-warning"></i>Restricted Discretionary</h5>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var activity in zoning.RestrictedDiscretionary)
                    {
                        <span class="badge bg-warning-subtle text-warning">@activity</span>
                    }
                </div>
            </div>
        }

        <!-- Non-Complying / Prohibited -->
        @if (zoning.NonComplying?.Count > 0 || zoning.ProhibitedActivities?.Count > 0)
        {
            <div class="data-section">
                <h5><i class="fa fa-ban me-2 text-danger"></i>Non-Complying / Prohibited</h5>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var activity in zoning.NonComplying ?? [])
                    {
                        <span class="badge bg-danger-subtle text-danger">NC: @activity</span>
                    }
                    @foreach (var activity in zoning.ProhibitedActivities ?? [])
                    {
                        <span class="badge bg-danger text-white">Prohibited: @activity</span>
                    }
                </div>
            </div>
        }

        <!-- Overlays -->
        @if (zoning.Overlays?.Count > 0)
        {
            <div class="data-section">
                <h5><i class="fa fa-layer-group me-2"></i>Planning Overlays</h5>
                @foreach (var overlay in zoning.Overlays)
                {
                    <div class="d-flex justify-content-between align-items-start py-2 border-bottom">
                        <div>
                            <strong>@overlay.Name</strong>
                            <span class="badge bg-secondary ms-2">@overlay.Type</span>
                            @if (!string.IsNullOrEmpty(overlay.Description))
                            {
                                <div class="small text-muted mt-1">@overlay.Description</div>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(overlay.RulesLink))
                        {
                            <a href="@overlay.RulesLink" target="_blank" class="btn btn-sm btn-outline-primary">
                                View Rules <i class="fa fa-external-link-alt ms-1"></i>
                            </a>
                        }
                    </div>
                }
            </div>
        }

        <!-- Links -->
        @if (!string.IsNullOrEmpty(zoning.DistrictPlanLink) || !string.IsNullOrEmpty(zoning.ZoneRulesLink))
        {
            <div class="d-flex gap-3 mt-3">
                @if (!string.IsNullOrEmpty(zoning.DistrictPlanLink))
                {
                    <a href="@zoning.DistrictPlanLink" target="_blank" class="btn btn-outline-primary">
                        <i class="fa fa-book me-1"></i> View District Plan
                    </a>
                }
                @if (!string.IsNullOrEmpty(zoning.ZoneRulesLink))
                {
                    <a href="@zoning.ZoneRulesLink" target="_blank" class="btn btn-outline-secondary">
                        <i class="fa fa-gavel me-1"></i> View Zone Rules
                    </a>
                }
            </div>
        }

        <!-- Data Source -->
        @if (zoning.Source != null)
        {
            <div class="mt-4 p-3 bg-light rounded small">
                <i class="fa fa-database me-1"></i>
                <strong>Source:</strong> @zoning.Source.SourceName
                @if (!string.IsNullOrEmpty(zoning.Source.SourceUrl))
                {
                    <a href="@zoning.Source.SourceUrl" target="_blank" class="ms-2">
                        <i class="fa fa-external-link-alt"></i>
                    </a>
                }
                <span class="text-muted ms-2">Retrieved: @zoning.Source.RetrievedDate.ToString("dd MMM yyyy HH:mm")</span>
            </div>
        }
    }
    else
    {
        <!-- No Data Available -->
        <div class="text-center py-5">
            <div class="display-4 text-muted mb-3"><i class="fa fa-city"></i></div>
            <h5>Zoning Data Not Available</h5>
            <p class="text-muted">
                We couldn't retrieve zoning data for this location. This may be because:
            </p>
            <ul class="text-start text-muted" style="max-width: 400px; margin: 0 auto;">
                <li>The council GIS is temporarily unavailable</li>
                <li>The property is outside supported council areas</li>
                <li>The location couldn't be matched to a parcel</li>
            </ul>
            <form method="post" action="/SiteEvaluator/EvaluationWizard?handler=RefreshSection" class="mt-3">
                <input type="hidden" name="section" value="zoning" />
                <input type="hidden" name="currentStep" value="3" />
                <button type="submit" class="btn btn-outline-primary">
                    <i class="fa fa-sync me-1"></i> Try Again
                </button>
            </form>
        </div>
    }

    <!-- Navigation -->
    <div class="wizard-nav">
        <form method="post" action="/SiteEvaluator/EvaluationWizard?handler=PreviousStep" class="d-inline">
            <input type="hidden" name="currentStep" value="3" />
            <button type="submit" class="btn btn-outline-secondary btn-lg">
                <i class="fa fa-arrow-left me-2"></i>Back
            </button>
        </form>
        <div>
            @if (hasData)
            {
                <form method="post" action="/SiteEvaluator/EvaluationWizard?handler=RefreshSection" class="d-inline me-2">
                    <input type="hidden" name="section" value="zoning" />
                    <input type="hidden" name="currentStep" value="3" />
                    <button type="submit" class="btn btn-outline-secondary btn-lg">
                        <i class="fa fa-sync me-1"></i> Refresh
                    </button>
                </form>
            }
            <form method="post" action="/SiteEvaluator/EvaluationWizard?handler=NextStep" class="d-inline">
                <input type="hidden" name="currentStep" value="3" />
                <button type="submit" class="btn btn-primary btn-lg">
                    Next: Hazards
                    <i class="fa fa-arrow-right ms-2"></i>
                </button>
            </form>
        </div>
    </div>
</div>
